---
title: "Group X: Wine Reviews"
author: 'Jennifer , Gehua Zhang, Xinquan Wang, Yanzhi Zhang'
date: "April 25 2019"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r library, include=FALSE, warning=FALSE}
library(data.table)
library(ggplot2)
library(dplyr)
library(purrr)
library(tidyr)
library(lubridate)
library(corrplot)
library(gridExtra)
```

```{r read data+constant, echo=FALSE, warning=FALSE}
green <- fread(input = '../Data/2018_Green_Taxi_Trip_Data.csv',verbose = FALSE,na.strings=c(""))
weather <- fread(input = '../Data/weather_new.csv',verbose = FALSE,na.strings=c(""))

weather <- na.omit(weather)
```



# Introduction to the Problem: 

We used NYC green cab data provided by NYC open data which is a government-run orgnization

- **VendorID:** A code indicating the LPEP provider that provided the record.
1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.
- **lpep_pickup_datetime:** The date and time when the meter was engaged.
- **lpep_dropoff_datetime:** The date and time when the meter was disengaged.
- **Passenger_count:** The number of passengers in the vehicle. This is a driver-entered value.
- **Trip_distance:** The elapsed trip distance in miles reported by the taximeter.
- **PULocationID:** TLC Taxi Zone in which the taximeter was engaged
- **DOLocationID:** TLC Taxi Zone in which the taximeter was disengaged
- **RateCodeID**The final rate code in effect at the end of the trip.
1= Standard rate
2=JFK
3=Newark
4=Nassau or Westchester 5=Negotiated fare 6=Group ride
- **Store_and_fwd_flag** This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka “store and forward,” because the vehicle did not have a connection to the server.
Y= store and forward trip
N= not a store and forward trip
- **Payment_type:** The title of the wine review, which often contains the vintage if you're interested in extracting that feature
- **Fare_amount:** The type of grapes used to make the wine (ie Pinot Noir)
- **MTA_tax:** The winery that made the wine
- **Improvement_surcharge:** The winery that made the wine
- **Tip_amount:** The winery that made the wine
- **Tolls_amount:** The winery that made the wine
- **Total_amount:** The winery that made the wine
- **Trip_type:** The winery that made the wine



# Data Cleaning and Visualization

From a quick look in the data description pdf, we can find out the "VendorID", "Store_and_fwd_flag", "Payment_type", "ehail_fee" is not correlated with our problem, so we can drop those columns from the very beginning.

```{r drop_feature}
names(green)
green[, c("VendorID", "store_and_fwd_flag", "payment_type", "ehail_fee")] <- list(NULL)
```

The data is very large (793MB) and messy, we need to clean the data before we do data analysis.

# Location ID, Passenger Count

First, we look at the location ID if location ID is in the valid range that is 1 to 265.

```{r}
quantile(green$PULocationID, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
quantile(green$DOLocationID, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- green[PULocationID>=0&PULocationID<=266&DOLocationID>=0&DOLocationID<=266,]
```

Usually, we will only have 1 to 4 passenagers in a sedan or there might be more in different car models. Since this is a number enterred by driver, there could be mistakes in those data entries. Regardless of the possible passenagers, we take a 95% confidence interval on the passenager counts.

```{r}
quantile(pruned_green$passenger_count, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[passenger_count > 0 & passenger_count < 6,]
```
```{r}
pruned_green %>% 
  group_by(passenger_count) %>% 
  count() %>% 
  ggplot(aes(x=passenger_count,y=n, fill=passenger_count))+
  geom_col()+
  theme(legend.position = "none")
```

# Trip Distance 

```{r}
quantile(pruned_green$trip_distance, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[trip_distance > 0 & trip_distance <= 21.17,]
```

```{r}
pruned_green %>% 
  ggplot(aes(x=trip_distance)) + 
  geom_histogram(bins=100, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=11),axis.text = element_text(size=8))+
  ylab("Density")+coord_cartesian(x=c(0,25))
```

# All Kinds of Fares

```{r}
quantile(pruned_green$fare_amount, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[fare_amount >= 2.5 & fare_amount <= 58.0,]
```
```{r}
quantile(pruned_green$extra, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[extra >= 0 & extra <= 1,]
```
```{r}
quantile(pruned_green$mta_tax, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[mta_tax > 0 & mta_tax <= 0.5,]
```
```{r}
quantile(pruned_green$tip_amount, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[tip_amount >= 0 & tip_amount <= 0.5,]
```
```{r}
quantile(pruned_green$tolls_amount, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[tolls_amount >= 0 & tolls_amount <= 5.76,]
```
```{r}
quantile(pruned_green$improvement_surcharge, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[improvement_surcharge == 0.3, ]
```
```{r}
quantile(pruned_green$total_amount, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
pruned_green <- pruned_green[total_amount >= 3.3 & total_amount <= 73.32,]
```

# Visualiztion on Fare

```{r}
plot_1 <- pruned_green %>% 
  ggplot(aes(x=fare_amount)) + 
  geom_histogram(bins=50, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=11),axis.text = element_text(size=8))+
  ylab("Density")+coord_cartesian(x=c(0,60))
plot_3 <- pruned_green %>% 
  ggplot(aes(x=total_amount)) + 
  geom_histogram(bins=50, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=11),axis.text = element_text(size=8))+
  ylab("Density")+coord_cartesian(x=c(0,60))

grid.arrange(plot_1, plot_3, ncol= 2)
```


# Time Feature

The date columns are of type character, so they has to be converted into numeric feature. We convert the dates into the seconds elapsed from the first moment of 2018 and group them into time bins by hours. 

```{r data_cleaning_lpep_pickup_datetime_lpep_dropoff_datetime}
one.year <- (as.numeric(strptime("01/01/2019 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p")) - as.numeric(strptime("01/01/2018 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p"))) %/% 3600

pruned_green$pickup_hour <- 
  (as.numeric(strptime(pruned_green$lpep_pickup_datetime, "%m/%d/%Y %l:%M:%S %p")) - as.numeric(strptime("01/01/2018 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p"))) %/% 3600

pruned_green$dropoff_hour <- (as.numeric(strptime(pruned_green$lpep_dropoff_datetime, "%m/%d/%Y %l:%M:%S %p")) - as.numeric(strptime("01/01/2018 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p"))) %/% 3600
```


```{r}

quantile(pruned_green$pickup_hour, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))
quantile(pruned_green$dropoff_hour, probs = c(0, 0.005, 0.025, 0.5, 0.75, 0.975, 0.995, 1))

pruned_green <- pruned_green[pickup_hour>=0 & pickup_hour<=one.year,]
pruned_green <- pruned_green[dropoff_hour>=0 & dropoff_hour<=one.year,]
```

# Feature Engineering

We think trip can be a expressive feature for this model, so we calculates the duration simply by substracting drop-off hour by pickup-hour. 

```{r}
pruned_green$trip_duration <- 
  ((as.numeric(strptime(pruned_green$lpep_dropoff_datetime, "%m/%d/%Y %l:%M:%S %p")) - as.numeric(strptime("01/01/2018 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p")))
- 
  (as.numeric(strptime(pruned_green$lpep_pickup_datetime, "%m/%d/%Y %l:%M:%S %p")) - as.numeric(strptime("01/01/2018 12:00:00 AM", "%m/%d/%Y %l:%M:%S %p")))) /60

pruned_green <- pruned_green[trip_duration>=1.866667 & trip_duration<=46.400000,]

pruned_green %>% 
  ggplot(aes(x=trip_duration)) + 
  geom_histogram(bins=50, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=12),axis.text = element_text(size=12))+
  ylab("Density")+coord_cartesian(x=c(0,50))
```


# Weather Data

Weather is closely associated with taxi demand, people are more likely to call a cab in the cold snowy winter night than a pleasant spring morning. Therefore, we includes the 2018 hourly weather data from https://www.ncdc.noaa.gov/cdo-web/search recorded at central park station.

```{r}
plot1 <- weather %>% 
  ggplot(aes(x=HourlyDewPointTemperature)) + 
  geom_histogram(bins=100, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=12),axis.text = element_text(size=12))+
  ylab("Density")

plot2 <- weather %>% 
  ggplot(aes(x=HourlyPrecipitation)) + 
  geom_histogram(bins=100, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=12),axis.text = element_text(size=12))+
  ylab("Density")

plot3 <- weather %>% 
  ggplot(aes(x=HourlyWindSpeed)) + 
  geom_histogram(bins=50, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=12),axis.text = element_text(size=12))+
  ylab("Density")

grid.arrange(plot1, plot2, plot3, ncol = 3)
```
# Demand: Frequency of Pick-up

The demand is defined as the number of pick-ups in a certain time frame. In this model, we set the time frame as one hour.

```{r}
final_dt <- merge(x = pruned_green, y = weather[,-1], by.x = "pickup_hour", by.y = "HOUR")
final_dt <- merge(final_dt, final_dt[,.N, by = pickup_hour])

final_dt %>% 
  ggplot(aes(x=N)) + 
  geom_histogram(bins=1000, fill="red")+
  theme_bw()+theme(axis.title = element_text(size=12),axis.text = element_text(size=12))+
  ylab("Density") 
```


# Correlation Analysis

After carefully cleaning the data, we want to explore the correaltion between each variable.

```{r}
corr_features = final_dt[,.(pickup_hour, dropoff_hour, PULocationID,RatecodeID, trip_distance,passenger_count,trip_duration,fare_amount,tip_amount,tolls_amount,total_amount,trip_type,HourlyDewPointTemperature,HourlyPrecipitation,HourlyWindSpeed,N)] 
corrplot(cor(corr_features, use='complete.obs'), type='lower')
```